<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AutoCaption Pro – Fast Captions & Translation</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 2rem; max-width: 720px; }
    h1 { margin-bottom: .25rem; }
    p.lead { color: #555; margin-top: 0; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 1rem; }
    label { display: block; margin: .75rem 0 .25rem; }
    input, select, button { width: 100%; padding: .75rem; font-size: 1rem; border-radius: 10px; border: 1px solid #ccc; }
    button { cursor: pointer; background: #0a84ff; color: #fff; border: none; margin-top: 1rem; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    #msg { min-height: 1.25rem; }
    small.hint { color: #777; display: block; margin-top: .25rem; }
  </style>
</head>
<body>
  <h1>AutoCaption Pro</h1>
  <p class="lead">Paste your YouTube link → click Continue → we’ll create a session. Then pay with PayPal.</p>

  <div class="card">
    <form id="orderForm">
      <label for="email">Email (delivery address)</label>
      <input id="email" type="email" placeholder="you@example.com" autocomplete="email" required />

      <label for="video_url">YouTube URL</label>
      <input id="video_url" type="url" placeholder="https://www.youtube.com/watch?v=…" required />
      <small class="hint">Use a public, non-age-restricted video.</small>

      <label for="tier">Tier</label>
      <select id="tier" required>
        <option value="t10">$19 — up to 10 minutes</option>
        <option value="t30">$39 — up to 30 minutes</option>
        <option value="t5pack">$79 — 5-video pack (≤10m each)</option>
      </select>

      <button id="continueBtn" type="submit">Continue</button>

      <!-- Message line + PayPal buttons container -->
      <p id="msg" aria-live="polite" style="margin-top:8px;"></p>
      <div id="paypal-buttons" style="display:none; margin-top:12px;"></div>
    </form>
  </div>

  <!-- PayPal SDK: replace YOUR_SANDBOX_CLIENT_ID with your Sandbox client ID -->
  <script src="https://www.paypal.com/sdk/js?client-id=AaFBie0sJjcnsLD0YzGy-WqDrZ4gPcH97FzlUhoGNbaDJbumhG5UBS5cVh85PBzR7-UbmzEIyRzBoEkC&currency=USD&intent=CAPTURE"></script>

  <!-- Page script: create session, then render PayPal buttons -->
  <script>
    // Same-origin endpoints (Cloudflare Pages Functions)
    const SESSION_ENDPOINT = '/session';

    const $ = sel => document.querySelector(sel);
    const form    = $('#orderForm');
    const emailEl = $('#email');
    const urlEl   = $('#video_url');
    const tierEl  = $('#tier');
    const btn     = $('#continueBtn');
    const msgEl   = $('#msg');
    const payDiv  = $('#paypal-buttons');

    // Parse price from the selected tier text (e.g. "$19 — up to 10 minutes")
    function getAmountFromTier() {
      const t = tierEl?.selectedOptions?.[0]?.textContent || '';
      const m = t.match(/\$([0-9]+)/);
      return m ? m[1] : '19'; // default $19 if parsing fails
    }

    // Render PayPal Smart Buttons
    function renderPayPalButtons(session_id, amount, currency = 'USD') {
      if (!window.paypal) {
        msgEl.style.color = '#b00020';
        msgEl.textContent = 'PayPal SDK not loaded.';
        return;
      }
      // Avoid duplicate renders if user clicks twice
      payDiv.innerHTML = '';

      paypal.Buttons({
        style: { shape: 'pill', label: 'pay' },
        createOrder: (data, actions) => {
          return actions.order.create({
            purchase_units: [{ amount: { value: String(amount), currency_code: currency } }]
          });
        },
        onApprove: async (data, actions) => {
          try {
            const details = await actions.order.capture(); // capture on client for MVP
            msgEl.style.color = '#0a0';
            msgEl.textContent = 'Payment received. Finalizing...';

            // Notify backend so /status flips to "paid"
            await fetch('/paypal/notify', {
              method: 'POST',
              headers: { 'content-type': 'application/json' },
              body: JSON.stringify({
                session_id,
                order_id: data.orderID,
                capture: details
              })
            });
          } catch (err) {
            console.error(err);
            msgEl.style.color = '#b00020';
            msgEl.textContent = 'Could not complete payment. Please try again.';
            return;
          }

          // Redirect to per-job status (job_id == session_id)
          window.location.href = `/status?job_id=${encodeURIComponent(session_id)}`;
        },
        onError: (err) => {
          console.error(err);
          msgEl.style.color = '#b00020';
          msgEl.textContent = 'PayPal error. Please try again.';
        }
      }).render('#paypal-buttons');
    }

    // Create session then reveal PayPal buttons
    form?.addEventListener('submit', async (e) => {
      e.preventDefault();
      msgEl.style.color = '#000';
      msgEl.textContent = 'Creating session…';
      btn.disabled = true;

      try {
        const res = await fetch(SESSION_ENDPOINT, {
          method: 'POST',
          headers: { 'content-type': 'application/json' },
          body: JSON.stringify({
            email: (emailEl?.value || '').trim(),
            video_url: (urlEl?.value || '').trim(),
            tier: (tierEl?.value || '').trim()
          })
        });

        const data = await res.json().catch(() => ({}));
        if (!res.ok || !data.session_id) {
          msgEl.style.color = '#b00020';
          msgEl.textContent = data.error || 'Unable to create session.';
          btn.disabled = false;
          return;
        }

        const session_id = data.session_id;
        localStorage.setItem('session_id', session_id);
        const amount = getAmountFromTier();

        msgEl.style.color = '#0a0';
        msgEl.textContent = `Session created (#${session_id.slice(0,8)}). Choose PayPal to pay $${amount}.`;

        payDiv.style.display = 'block';
        renderPayPalButtons(session_id, amount, data.currency || 'USD');

      } catch (err) {
        console.error(err);
        msgEl.style.color = '#b00020';
        msgEl.textContent = 'Network error. Please try again.';
      } finally {
        btn.disabled = false;
      }
    });
  </script>
</body>
</html>

